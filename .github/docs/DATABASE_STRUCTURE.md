# Database Structure - Correct Collections

## Collections Overview

### 1. `venues` Collection
**Purpose**: Store venue/ground information

**Document ID**: Auto-generated by Firestore

**Fields**:
- `name` (string) - Venue name
- `description` (string) - Venue description
- `latitude` (number) - Location latitude
- `longitude` (number) - Location longitude
- `address` (string, optional) - Street address
- `imageUrls` (array) - Array of image URLs
- `pricePerHour` (number) - Price per hour
- `attributes` (object) - Key-value pairs (e.g., parking, covered)
- `createdAt` (string) - ISO date string
- `managedBy` (string) - User UID of the manager

**Example**:
```javascript
venues/{venueId}
{
  name: "Champion Futsal Arena",
  description: "Indoor futsal with excellent facilities",
  latitude: 27.7172,
  longitude: 85.3240,
  address: "Kumaripati, Lalitpur",
  imageUrls: ["https://...", "https://..."],
  pricePerHour: 1500,
  attributes: { parking: "Available", covered: "Yes" },
  createdAt: "2025-11-18T10:30:00.000Z",
  managedBy: "user123abc"
}
```

---

### 2. `venueSlots` Collection (New Architecture)
**Purpose**: Store slot configuration and exceptions per venue

**Document ID**: Same as venue ID (venues/{venueId})

**Fields**:
- `venueId` (string) - Reference to venue
- `config` (object) - Slot generation configuration
  - `startTime` (string) - e.g., "06:00"
  - `endTime` (string) - e.g., "22:00"
  - `slotDuration` (number) - Minutes (e.g., 60)
  - `daysOfWeek` (array) - [0,1,2,3,4,5,6] (0=Sunday)
  - `timezone` (string) - e.g., "Asia/Kathmandu"
- `blocked` (array) - Blocked slots
  - `date` (string) - "2025-11-20"
  - `startTime` (string) - "10:00"
  - `reason` (string, optional)
  - `blockedBy` (string, optional) - Manager UID
  - `blockedAt` (timestamp)
- `bookings` (array) - Booked slots
  - `date` (string)
  - `startTime` (string)
  - `bookingId` (string)
  - `bookingType` (string) - "physical" or "website"
  - `status` (string) - "confirmed" or "pending_payment"
  - `customerName` (string, optional)
  - `customerPhone` (string, optional)
  - `userId` (string, optional)
  - `notes` (string, optional)
  - `createdAt` (timestamp)
- `held` (array) - Temporarily held slots (5 min)
  - `date` (string)
  - `startTime` (string)
  - `userId` (string)
  - `bookingId` (string)
  - `holdExpiresAt` (timestamp)
  - `createdAt` (timestamp)
- `reserved` (array) - Manager reservations
  - `date` (string)
  - `startTime` (string)
  - `note` (string, optional)
  - `reservedBy` (string) - Manager UID
  - `reservedAt` (timestamp)
- `updatedAt` (timestamp)

**Example**:
```javascript
venueSlots/{venueId}
{
  venueId: "venue123",
  config: {
    startTime: "06:00",
    endTime: "22:00",
    slotDuration: 60,
    daysOfWeek: [0,1,2,3,4,5,6],
    timezone: "Asia/Kathmandu"
  },
  blocked: [
    {
      date: "2025-11-20",
      startTime: "10:00",
      reason: "Maintenance",
      blockedAt: Timestamp(...)
    }
  ],
  bookings: [
    {
      date: "2025-11-21",
      startTime: "14:00",
      bookingId: "booking_xyz",
      bookingType: "physical",
      status: "confirmed",
      customerName: "John Doe",
      customerPhone: "9841234567",
      createdAt: Timestamp(...)
    }
  ],
  held: [],
  reserved: [],
  updatedAt: Timestamp(...)
}
```

---

### 3. `bookings` Collection
**Purpose**: Store booking transaction records

**Fields**:
- `venueId` (string) - Reference to venue
- `userId` (string) - User who booked
- `date` (string) - "2025-11-20"
- `startTime` (string) - "14:00"
- `endTime` (string) - "15:00"
- `bookingType` (string) - "physical" or "website"
- `status` (string) - "pending_payment", "confirmed", "cancelled"
- `customerName` (string, optional) - For physical bookings
- `customerPhone` (string, optional) - For physical bookings
- `notes` (string, optional)
- `amount` (number) - Price paid
- `createdAt` (timestamp)
- `paymentTimestamp` (timestamp, optional)

---

### 4. `users` Collection
**Purpose**: Store user information

**Fields**:
- `email` (string)
- `role` (string) - "user", "manager", "admin"
- `name` (string)
- `phoneNumber` (string, optional)
- Other user profile fields...

---

## Key Differences from Old System

### Old System (Inefficient)
```
slots (collection)
  └── venue1_2025-11-20_0600 (document)
  └── venue1_2025-11-20_0700 (document)
  └── venue1_2025-11-20_0800 (document)
  ... (70 documents per venue per week!)
```

**Problems**:
- 70 reads per weekly view
- 70 writes per day for slot generation
- Expensive and hits Firestore limits quickly

### New System (Efficient)
```
venueSlots (collection)
  └── venue1 (document with config + exceptions only)
```

**Benefits**:
- 1 read per weekly view (70x reduction!)
- 0 writes for slot generation (slots reconstructed on-demand)
- Only store exceptions (blocked, booked, held, reserved)
- 99% storage reduction

---

## How Slots Work Now

1. **Configuration**: Venue has `venueSlots/{venueId}` with config
2. **On-Demand Generation**: When viewing slots, `reconstructSlots()` generates:
   - All time slots based on config (start, end, duration, days)
   - Marks exceptions (blocked, booked, held, reserved)
   - Everything else is AVAILABLE (not stored)
3. **Booking**: Add to `bookings` array in `venueSlots/{venueId}`
4. **Display**: Reconstruct slots and overlay bookings

---

## Migration Notes

- Old `slots` collection is preserved for rollback
- New venues automatically use `venueSlots` structure
- Migration script available: `lib/migrations/migrate-slots.ts`

---

## Important Field Names

✅ **Correct**:
- Collection: `venues` (not "grounds")
- Manager field: `managedBy` (not "managerId")
- Venue ID param: `groundId` in components (legacy naming, but refers to venue)

❌ **Incorrect** (don't use):
- Collection: "grounds"
- Manager field: "managerId"
